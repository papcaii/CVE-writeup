# CVE-2023-21768

CVE-2023-21768 target đến afd.sys - một driver handle các network operations, như socket...

## Reverse

Trước hết ta sẽ dùng một kĩ thuật là binary diff giữa bản patched và bản chưa patched để xác định và giới hạn các hàm được fix
<img src="https://i.imgur.com/QMgSJJf.png">

Rất may là chỉ có 1 hàm được thay đổi, đó chính là hàm `afd!AfdNotifyRemoveIoCompletion`
<img src="https://i.imgur.com/YxhV4ZW.png">

Như đã thấy thì ở bản patched hàm ProbeForWrite đã được thêm vào ở case khi `PreviousMode != 0` (Nếu `PreviousMode = 0` nghĩa là chương trình đang chạy ở Kernel mode, ngược lại thì đang ở User mode)
Hàm này sẽ kiểm tra xem liệu address đưa vào có phải địa chỉ hợp lệ nằm trong User mode không

--> Từ đó ta có thể suy ra rằng nếu ta có thể pass một address nằm ở Kernel mode ta có thể có được quyền write trên toàn memory

Tuy nhiên, để khai thác được lỗ hổng này thì ta phải tìm hiểu xem làm thế nào để kích hoạt được đoạn code lỗi ở trên. Ta thấy `AfdNotifyRemoveIoCompletion` chỉ được gọi duy nhất bởi hàm `AfdNotifySock`.
<img src="https://i.imgur.com/4mnUtFX.png">

Tuy nhiên, `AfdNotifySock` lại không được gọi trực tiếp bởi hàm nào. Địa chỉ của
hàm này nằm trong một bảng địa chỉ hàm có tên là `AfdImmediateCallDispatch`.
Các hàm này được ánh xạ từ bảng `AfdIrpCallDispatch`, chứa các dispatch routine cho
AFD driver. Dispatch routine được sử dụng để xử lý các request từ ứng dụng win32
khi gọi `DeviceIoControl`. Control code của mỗi hàm được ghi trong `AfdIoctlTable`.
<img src="https://i.imgur.com/hRwUwVh.png">

Mỗi control code có kích thước 4 byte. Offset của `AfdNotifySock` trong bảng
`AfdImmediateCallDispatch` là 74. Áp vào bảng `AfdIoctlTable`, ta thấy control code
của `AfdNotifySock` là 0x12127.

`AfdNotifySock` có thể gọi thông qua DeviceIoControl, nhưng nếu dựa vào [Code](https://www.x86matthew.com/view_post?id=ntsockets) của x86matthew ta có thể bỏ qua WinSock mà gọi thẳng đến AFD driver thông qua `NtCreateFile` và `NtDeviceIoControlFile`.
<img src="https://i.imgur.com/g6LEhri.png">

Sau khi tạo socket, ta có thể giao tiếp với AFD driver thông qua việc sử dụng
`NtDeviceIoControlFile`. Giá trị `IoControlCode` được truyền vào hàm sẽ đại diện
cho hành động mà ta muốn thực hiện (kết nối, gửi, nhận,...).
<img src="https://i.imgur.com/Ej88KdZ.png">

